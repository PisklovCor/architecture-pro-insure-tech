# Анализ проблем и рисков текущей архитектуры InsureTech

## Текущая архитектура взаимодействия

### Описание текущих взаимодействий

1. **core-app ↔ ins-product-aggregator**
   - Тип: Синхронный REST API
   - Частота: Раз в 15 минут
   - Назначение: Получение актуальных данных о продуктах и тарифах для локальной реплики
   - Данные: Список доступных продуктов от всех страховых компаний

2. **ins-comp-settlement ↔ ins-product-aggregator**
   - Тип: Синхронный REST API
   - Частота: Раз в сутки (ночью)
   - Назначение: Получение данных о продуктах для формирования реестра оформленных страховок
   - Данные: Список доступных продуктов от всех страховых компаний

3. **ins-comp-settlement ↔ core-app**
   - Тип: Синхронный REST API
   - Частота: Раз в сутки (ночью)
   - Назначение: Получение всех оформленных за день страховок
   - Данные: Список оформленных страховок за день

### Текущие проблемы

1. **Задержки ответов**
   - При запросе к ins-product-aggregator происходит синхронный вызов всех 5 страховых компаний
   - Время ответа зависит от самой медленной страховой компании
   - При росте до 10 компаний время ответа может увеличиться в 2 раза
   - Блокирующие запросы снижают производительность сервисов

2. **Ошибки взаимодействия**
   - Ошибка одной страховой компании может привести к ошибке всего запроса
   - Нет механизма частичного успеха (часть данных получена, часть нет)
   - Сложность обработки временных сбоев (retry логика)
   - Ошибки API страховых компаний влияют на доступность ins-product-aggregator

3. **Проблемы с локальными репликами**
   - Данные могут быть неактуальными между обновлениями (до 15 минут для core-app, до 24 часов для ins-comp-settlement)
   - Риск использования устаревших тарифов при оформлении страховок
   - Дублирование данных в нескольких сервисах усложняет поддержку консистентности

4. **Пиковые нагрузки**
   - Периодические запросы создают пиковые нагрузки на ins-product-aggregator
   - Одновременные запросы от нескольких инстансов core-app могут перегрузить систему
   - Нет механизма сглаживания нагрузки

## Риски при росте нагрузки

### Риск 1: Масштабирование количества страховых компаний

**Текущее состояние:** 5 страховых компаний  
**Планируемое состояние:** 10 страховых компаний (рост в 2 раза)

**Проблемы:**
- Время ответа ins-product-aggregator увеличится пропорционально количеству компаний
- Вероятность ошибки хотя бы одной компании увеличится
- Нагрузка на сеть и ресурсы сервера возрастет в 2 раза
- Таймауты запросов станут более частыми

**Влияние:**
- Увеличение времени ответа core-app при обновлении реплики
- Рост количества ошибок в ins-comp-settlement при формировании реестра
- Снижение доступности сервисов из-за каскадных сбоев

### Риск 2: Рост количества инстансов сервисов

**Проблемы:**
- При горизонтальном масштабировании core-app количество запросов к ins-product-aggregator увеличится пропорционально количеству подов
- Каждый под core-app будет делать запросы раз в 15 минут независимо
- Создание пиковых нагрузок при одновременных запросах
- Перегрузка ins-product-aggregator при масштабировании

**Влияние:**
- Необходимость масштабирования ins-product-aggregator для обработки пиковых нагрузок
- Увеличение стоимости инфраструктуры
- Сложность прогнозирования нагрузки

### Риск 3: Каскадные сбои

**Проблемы:**
- Сбой ins-product-aggregator приводит к недоступности данных для core-app и ins-comp-settlement
- Ошибки API страховых компаний могут привести к полной недоступности ins-product-aggregator
- Нет механизма изоляции ошибок
- Отсутствие fallback механизмов

**Влияние:**
- Полная остановка работы core-app при недоступности ins-product-aggregator
- Невозможность формирования реестра в ins-comp-settlement
- Нарушение SLA для пользователей и партнеров

### Риск 4: Проблемы с консистентностью данных

**Проблемы:**
- Локальные реплики в core-app и ins-comp-settlement могут расходиться
- Разная частота обновления (15 минут vs 24 часа) создает разные версии данных
- Риск использования устаревших тарифов при оформлении страховок
- Сложность синхронизации при изменении структуры данных

**Влияние:**
- Финансовые потери из-за использования устаревших тарифов
- Некорректные расчеты в ins-comp-settlement
- Проблемы с аудитом и отчетностью

### Риск 5: Узкие места производительности

**Проблемы:**
- ins-product-aggregator становится узким местом системы
- Синхронные запросы блокируют выполнение других операций
- Нет возможности параллельной обработки запросов к разным страховым компаниям
- Ограничение пропускной способности из-за синхронной модели

**Влияние:**
- Ограничение масштабируемости системы
- Рост времени отклика при увеличении нагрузки
- Необходимость вертикального масштабирования ins-product-aggregator

### Риск 6: Сложность обработки ошибок

**Проблемы:**
- Нет механизма повторных попыток (retry) с экспоненциальной задержкой
- Сложность обработки частичных успехов (часть компаний ответила, часть нет)
- Отсутствие механизма dead letter queue для проблемных запросов
- Нет логирования и мониторинга ошибок взаимодействия

**Влияние:**
- Потеря данных при временных сбоях
- Необходимость ручного вмешательства при ошибках
- Сложность диагностики проблем

## Критические проблемы для бизнеса

### Проблема 1: Нарушение SLA

При росте нагрузки и количества страховых компаний:
- Увеличение времени ответа API
- Рост количества ошибок
- Нарушение SLA для B2B-клиентов
- Финансовые потери из-за штрафов за нарушение SLA

### Проблема 2: Финансовые риски

- Использование устаревших тарифов может привести к финансовым потерям
- Некорректные расчеты в ins-comp-settlement влияют на взаиморасчеты со страховыми компаниями
- Потеря данных при сбоях требует ручного восстановления

### Проблема 3: Ограничение масштабируемости

- Текущая архитектура не позволяет эффективно масштабироваться
- Рост количества страховых компаний требует переработки архитектуры
- Сложность добавления новых интеграций

## Выводы

Текущая синхронная архитектура с периодическими запросами и локальными репликами имеет следующие критические недостатки:

1. **Не масштабируется** - при росте количества страховых компаний и инстансов сервисов производительность деградирует
2. **Не отказоустойчива** - ошибки одного компонента влияют на всю систему
3. **Не консистентна** - локальные реплики могут расходиться
4. **Создает узкие места** - ins-product-aggregator становится bottleneck
5. **Сложна в поддержке** - нет механизмов обработки ошибок и мониторинга

**Необходимо перейти на Event-Driven архитектуру** для решения всех выявленных проблем и обеспечения масштабируемости системы при росте нагрузки.

